<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ä»˜éŒ¢å°éŠæˆ²</title>
<style>
@font-face{
  font-family:"BpmfZihiKaiStd-Regular";
  src: local("BpmfZihiKaiStd-Regular");
}
body{
  margin:0;
  font-family:"BpmfZihiKaiStd-Regular", sans-serif;
  background:#f2f2f2;
  overflow-x:hidden;
  overflow-y:auto;
}
/* ===== æç¤ºé  ===== */
#intro{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:50000;
}
.slide{
  position:relative;
  width: 80%;
  max-width: 1000px;
  height:95%;
  background:#97CBFF;
  border-radius:20px;
  padding:20px 40px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
}

.slideContentLeft{
  text-align:left;
  font-size:20px;
  line-height:1.2;
  margin-top: 0;

  /* è¨ˆç®—æœ€å¤§é«˜åº¦ = è¦–çª—é«˜åº¦ x 0.95(è—æ¡†) - å›ºå®šå…ƒç´ é«˜åº¦(æ¨™é¡Œ+åœ–ç‰‡+æŒ‰éˆ•) */
  max-height: calc(95vh - 160px); 
  overflow-y: auto;
  padding-right: 20px; /* é¿å…å·è»¸è“‹æ–‡å­— */
  padding-top: 10px;
  padding-bottom: 10px;
}

/* é æ•¸é¡¯ç¤º */
.slidePageNumber {
  position: absolute;
  top: 40px;
  left: 40px;   /* â† æ”¹æˆ left */
  right: auto;  /* â† åŠ é€™è¡Œé¿å…è¡çª */
  font-family: "BpmfZihiKaiStd-Regular";
  font-size: 18px;
  color: #ffffff;
}

/* ç•¥éæ•™å­¸æŒ‰éˆ• */
#skipBtn {
  display: none;
  background: #444444;
  color: white;
  font-size: 22px;
  padding: 12px 30px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  position: absolute;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  font-family: "BpmfZihiKaiStd-Regular";
}

/* ===== åœ–ç‰‡å›ºå®šé«˜åº¦å®¹å™¨ ===== */
.imageBox {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  flex-shrink: 0; /* ä¸è¢«å£“ç¸® */
  max-height: 40%; /* é«˜åº¦ä¸Šé™ç‚ºè—æ¡†çš„ 40% */
  width: 100%;
}

.imageBox img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain; /* ä¿æŒå®Œæ•´æ¯”ä¾‹ */
  display: block;
}

/* ===== å‡è£è‡ªå·±æ˜¯éŠæˆ²æ¨™é¡Œ ===== */
.textTitle{
  font-size:36px;
  margin:0;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-weight:bold; 
  margin-bottom:45px; 
}

/* ===== æ“ä½œèªªæ˜æ¨™é¡Œå€ ===== */
.topTitleBox{
  height:50px;
  width:200px;
  border:3px solid #ffffff;
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  font-weight:bold;
  margin-bottom:45px;
  margin-left:auto;
  margin-right:auto;
}

.navBtn{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  font-size:26px;
  padding:12px 18px;
  border-radius:50%;
  background:white;
  border:none;
  cursor:pointer;
  font-family:"BpmfZihiKaiStd-Regular";
  display:flex;
  align-items:center;
  justify-content:center;
}
#prevBtn{left:-35px;}
#nextBtn{right:-35px;}
#startBtn{
  display:none;
  background:#0066CC;
  color:white;
  font-size:22px;
  padding:12px 30px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  position:absolute;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  font-family:"BpmfZihiKaiStd-Regular";
}

/* ===== éŠæˆ²ç‰ˆé¢ ===== */
#game{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
#top{
  display:flex;
  flex:1;   /* è‡ªå‹•æ’æ»¿å‰©é¤˜é«˜åº¦ */
  min-height:0; /* é˜²æ­¢çˆ†é–‹ */
  overflow:auto;
}
#left{
  flex:2;
  display:flex;
  align-items:center;
  justify-content:center;  
  position:relative;
  background:#ffffff;
}
#right{
  flex:1;
  display:flex;
  flex-direction:column;
  background:#e6f4ff;
}
#product{
  width: 80%;
  max-width: 500px;
  aspect-ratio: 1 / 1;   /* ä¿æŒæ­£æ–¹å½¢ */
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

#product img{
  width:100%;
  height:100%;
  object-fit:contain;
}
#priceTag{
  position:absolute;
  bottom:10px;  
  right:10px;   
  background:#97CBFF;
  padding:12px 22px;
  border-radius:14px;
  font-size:34px;
}
#replayBtn{
  position:fixed;
  top:10px;
  left:10px;
  background:#97CBFF;
  border:none;
  border-radius:10px;
  padding:10px 14px;
  cursor:pointer;
  font-size:20px;
  font-family:"BpmfZihiKaiStd-Regular";
}
#sumArea{
  height:25%;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  font-size:30px;
  background:#cfe8ff;
}
#eyeBtn{
  position:absolute;
  right:15px;
  bottom:15px;
  cursor:pointer;
}
#payZone{
  height:60%;
  border:3px dashed #666;
  border-radius:20px;
  margin:10px;
  padding:10px;
  position:relative;
  background:#ffffff;
}
#payZone::before {
  content: "ä»˜éŒ¢å€";
  position: absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-family:"BpmfZihiKaiStd-Regular";
  color:#cccccc;
  font-size:24px;
  pointer-events:none;
  z-index:0;
}

#finishBtn{
  margin:10px auto;
  padding:12px 30px;
  font-size:22px;
  font-family:"BpmfZihiKaiStd-Regular";
  border-radius:14px;
  border:none;
  background:#0066CC;
  color:white;
  cursor:pointer;
  display:block;
}

#coins{
  flex-shrink:0;   /* ä¸è¢«å£“ç¸® */
  padding:20px 60px;
  background:#d9d9d9;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:40px;
  padding:20px 60px;
  min-height:100px;
  box-sizing:border-box;
}
.coin{
  border:3px solid #333;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
  user-select:none;
  font-weight:bold;
  position:relative;
  font-family:"BpmfZihiKaiStd-Regular";
}
.coin[data-value="1000"]{width:110px;height:60px;background:#ABDBED;border-radius:12px;}
.coin[data-value="100"]{width:95px;height:60px;background:#EDABAB;border-radius:12px;}
.coin[data-value="10"]{width:60px;height:60px;background:#D7D4CB;border-radius:50%;}
.coin[data-value="1"]{width:45px;height:45px;background:#D6B880;border-radius:50%;}

#historyBtn{
  background:#97CBFF;
  font-size:24px;
  padding:14px 28px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  font-family:"BpmfZihiKaiStd-Regular";
}



/* ===== æ­·å²è¦–çª— ===== */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:30000;
}
.modalContent{
  width:66%;
  max-width:700px;
  height:80%;
  margin-left:0;
  background:#97CBFF;
  border-radius:20px;
  padding:40px;
  box-sizing:border-box;
  text-align:center;
  overflow:auto;
  margin-right:30%;   /* âœ… é å·¦ */
  margin-left:0;
}
.historyBlock{
  margin:20px 0;
}
.historyCoins{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:flex-end;
  flex-wrap:wrap;
}

.historyCoins .coinWrapper{
  display:flex;
  align-items:flex-end;
  margin-right:8px;
}
.historyCoins .coin{
  width:auto; height:auto;
  padding:10px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  margin-bottom:0;
}
.historyCoins .coin[data-value="1000"] {
  width:10vw;
  max-width:110px;
  height:5vw;
  max-height:60px;
  border-radius:12px;
  padding:0;
  font-size:16px;
}
.historyCoins .times{
  margin-left:4px;
  font-size:18px;
  align-self:flex-end;
}
.historyTitle{
  font-size:22px;
  margin-bottom:10px;
}

@media (max-width:1000px){

  #top{
    flex-direction:column;
  }

  #left{
    height:45vh;
  }

  #right{
    height:auto;
    flex:1;
  }

  #payZone{
    min-height:200px;
  }

  #coins{
    flex-wrap:wrap;
    gap:20px;
    justify-content:center;
  }

  #sumArea{
    display:flex;
    align-items:center;
    min-height:80px;
    gap:clamp(10px, 2vw, 30px);
    padding:0 10px;
  }

  #eyeBtn{
    position:static;
    right: 10px;

    margin-left:0;
  }

  #sumText{
    flex:1;
    text-align:center;
  }

  .modalContent{
    width:90%;
    height:50%;
    align-self:flex-start;
    margin-top:40px;
  }

}

/* ===== å€æ•¸è¼¸å…¥å°è¦–çª— ===== */
.multiplierPopup{
  position:absolute;
  background:#0066CC;
  padding:10px 14px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  z-index:20000;
}

.multiplierPopup input{
  width:70px;
  font-size:18px;
  text-align:center;
  font-family:"BpmfZihiKaiStd-Regular";
  border:none;
  border-radius:6px;
  padding:4px;
}

.multiplierConfirm{
  background:white;
  border:none;
  border-radius:8px;
  padding:4px 12px;
  font-size:18px;
  cursor:pointer;
  font-family:"BpmfZihiKaiStd-Regular";
}

#gameModal{
  position:fixed; 
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:40000; /* è“‹åœ¨ä»˜éŒ¢å€å’ŒéŒ¢å¹£ä¸Š */
  pointer-events: all; 
}

.gameModalBox{
  background:#97CBFF;
  padding:30px 20px;
  border-radius:20px;
  width:90%;
  max-width:400px;
  text-align:center;
  font-family:"BpmfZihiKaiStd-Regular";
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

#gameModalBtn{
  margin-top:20px;
  padding:10px 30px;
  font-size:20px;
  border:none;
  border-radius:12px;
  background:#0066CC;
  color:white;
  cursor:pointer;
  font-family:"BpmfZihiKaiStd-Regular";
}

</style>
</head>
<body>

<div id="game">
  <div id="top">
    <div id="left">
      <div id="product">
        <img src="product.png" alt="å•†å“åœ–ç‰‡">
        <button id="replayBtn">é‡çœ‹æ“ä½œèªªæ˜</button>
      </div>
      <div id="priceTag">3512å…ƒ</div>
    </div>
    <div id="right">
      <div id="sumArea">
        <span id="sumText">ï¼Šï¼Šï¼Šï¼Š</span>
        <span id="eyeBtn">ğŸ‘</span>
      </div>
      <div id="payZone"></div>
   <button id="finishBtn">å®Œæˆä»˜æ¬¾</button>

    </div>
  </div>
  <div id="coins">
    <div style="display:flex;gap:40px;align-items:center;">
      <div class="coin" data-value="1000">1000</div>
      <div class="coin" data-value="100">100</div>
      <div class="coin" data-value="10">10</div>
      <div class="coin" data-value="1">1</div>
    </div>
    <button id="historyBtn">éå»ä»˜æ¬¾æ–¹å¼</button>
  </div>
</div>

<div id="intro">
  <div class="slide">
    <span class="slidePageNumber" id="slideNumber"></span>
    <button id="prevBtn" class="navBtn" onclick="prevSlide()"><</button>
    <button id="nextBtn" class="navBtn" onclick="nextSlide()">></button>
    <div id="slideContent"></div>
    <button id="startBtn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    <button id="skipBtn" onclick="startGame()">ç•¥éæ•™å­¸</button>
  </div>
</div>

   <div id="modal"><div class="modalContent" id="modalContent">  </div>
</div>

<div id="gameModal">
  <div class="gameModalBox">
    <div id="gameModalText"></div>
    <button id="gameModalBtn">ç¹¼çºŒ</button>
  </div>
</div>

<script>
// ===== éŠæˆ²æ•¸æ“š =====
const PRICE=3512;
const REQUIRED_WAYS=3;
let currentSum=0;
let history=[];
let showSum=false;
let replayMode=false; // åˆ¤æ–·æ˜¯å¦å¾é‡æ–°çœ‹æ“ä½œèªªæ˜é–‹å•Ÿ

// ===== éŸ³æ•ˆ =====
const coinPlaceSound = new Audio('coinPlace.mp3');   
const coinRemoveSound = new Audio('coinRemove.mp3'); 
const successNewSound = new Audio('successNew.mp3');
const successRepeatSound = new Audio('successRepeat.mp3');
const successAllSound = new Audio('successAll.mp3');
const btnClickSound = new Audio('btnClick.mp3');

// ===== é è¼‰å…¥åœ–ç‰‡ =====
[
  'intro2.png',
  'intro3.png',
  'intro4.png',
  'intro5.png',
  'intro6.png'
].forEach(src=>{
  const img = new Image();
  img.src = src;
});

// ===== æç¤ºé å…§å®¹ =====
const slides=[
`<div class="slideFirst">
  <div class="textTitle">
    ä»˜éŒ¢å°éŠæˆ²
  </div>
  <div class="slideContentLeft">
    <p>æˆ‘å€‘åœ¨è²·æ±è¥¿æ™‚ï¼Œ</p>
    <p>å¯ä»¥ç”¨ä¸ä¸€æ¨£çš„éŒ¢å¹£çµ„åˆä¾†ä»˜éŒ¢ã€‚</p>
    <p>åƒ10å¡ŠéŒ¢å°±å¯ä»¥ä»˜1å€‹10å¡Šæˆ–10å€‹1å¡Šã€‚</p>
    <p>æ¥ä¸‹ä¾†è«‹è©¦è©¦çœ‹ç”¨ä¸åŒçš„3ç¨®æ–¹å¼ä¾†ä»˜éŒ¢å§ï¼</p>
  </div>
</div>`,

`<div class="topTitleBox">æ“ä½œèªªæ˜</div>
<div class="slideContentLeft">
  
  <p>åœ¨éŠæˆ²ç•«é¢ä¸­é–“æœƒæœ‰ä¸€ó ‡¡æ¨£å•†å“ã€‚</p>
  <p>åœ¨å•†å“å³ä¸‹è§’çš„è—è‰²æ¡†è£¡ï¼Œ</p>
  <p>æ˜¯ä½ è¦æ”¯ä»˜çš„åƒ¹éŒ¢ã€‚</p>

 <div class="imageBox">
  <img src="intro2.png" alt="èªªæ˜åœ–ç‰‡2">
 </div>
</div>`,

`<div class="topTitleBox">æ“ä½œèªªæ˜</div>
<div class="slideContentLeft">
  <p>åœ¨éŠæˆ²ç•«é¢çš„ä¸‹æ–¹æœ‰1000å…ƒã€100å…ƒã€10å…ƒèˆ‡1å…ƒã€‚</p>
  <p>è«‹é•·æŒ‰éŒ¢å¹£ä¾†ç§»å‹•å®ƒå€‘åˆ°ä»˜éŒ¢å€ä¾†æ”¯ä»˜ã€‚</p>

  <div class="imageBox">
  <img src="intro3.png" alt="èªªæ˜åœ–ç‰‡3">
  </div>

</div>`,

`<div class="topTitleBox">æ“ä½œèªªæ˜</div>
<div class="slideContentLeft">

  <p>å¦‚æœä¸å°å¿ƒæ”¾éŒ¯éŒ¢å¹£ï¼Œ</p>
  <p>é»ä¸€ó ‡¡ä¸‹åœ¨ä»˜éŒ¢å€çš„éŒ¢å¹£å°±å¯ä»¥ç§»é™¤ã€‚</p>
  <div class="imageBox">
   <img src="intro4.png" alt="èªªæ˜åœ–ç‰‡4">
  </div>
</div>`,

`<div class="topTitleBox">æ“ä½œèªªæ˜</div>
<div class="slideContentLeft">

  <p>åœ¨ä»˜éŒ¢å€ä¸‹æ–¹çš„ã€Œéå»ä»˜æ¬¾æ–¹å¼ã€æŒ‰éˆ•ï¼Œ</p>
  <p>å¯ä»¥è®“ä½ çœ‹åˆ°ç”¨éçš„ä»˜éŒ¢æ–¹å¼ã€‚</p>

  <div class="imageBox">
   <img src="intro5.png" alt="éå»ä»˜æ¬¾æ–¹å¼åœ–ç‰‡">
  </div>
</div>`,

`<div class="topTitleBox">æ“ä½œèªªæ˜</div>
<div class="slideContentLeft">
 
  <p>åœ¨ä»˜éŒ¢å€ä¸Šæ–¹ï¼Œ</p>
  <p>æœƒæ˜¯ä½ å·²ç¶“æ”¯ä»˜çš„é‡‘é¡ã€‚</p>
  <p>æŒ‰å³ä¸‹è§’çš„çœ¼ç›å°±å¯ä»¥æŸ¥çœ‹ä½ æ”¯ä»˜çš„ç¸½é‡‘é¡ã€‚</p>
  <div class="imageBox">
   <img src="intro6.png" alt="èªªæ˜åœ–ç‰‡5">
  </div>
</div>`,

`<div class="topTitleBox">æ“ä½œèªªæ˜</div>
<div class="slideContentLeft">
  <p>ç•¶æ”¯ä»˜çš„é‡‘é¡å‰›å¥½æ™‚ï¼Œ</p>
  <p>å°±æœƒè‡ªå‹•å®Œæˆ1ç¨®ä»˜æ¬¾æ–¹å¼ã€‚</p>
  <p>ä½ ç¸½å…±éœ€è¦å®Œæˆ3ç¨®ä¸åŒæ–¹å¼å–”ï¼</p>
  <p>ä¸€ó ‡¢èµ·ä¾†è©¦è©¦çœ‹å§ï¼</p>
</div>`
];

// ==== é‡çœ‹èªªæ˜ ==== //

const replaySlides = slides.slice(1); // é‡çœ‹èªªæ˜ç”¨ï¼ˆæ‹¿æ‰ç¬¬ä¸€é ï¼‰

// ===== æ§åˆ¶ =====
let currentSlide=0;
function renderSlide(){
  const slideContent = document.getElementById('slideContent');
  const currentSlides = replayMode ? replaySlides : slides;

  slideContent.innerHTML = currentSlides[currentSlide];

  const contentDiv = slideContent.querySelector('.slideContentLeft');
  if(contentDiv){
    contentDiv.style.display = 'flex';
    contentDiv.style.flexDirection = 'column';
    contentDiv.style.justifyContent = 'flex-start';
  }

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const startBtn = document.getElementById('startBtn');
  const skipBtn = document.getElementById('skipBtn');
  const pageNumber = document.getElementById('slideNumber');

  pageNumber.textContent = `${currentSlide + 1}/${currentSlides.length}`;

  prevBtn.style.display = currentSlide === 0 ? 'none' : 'block';
  nextBtn.style.display = currentSlide === currentSlides.length - 1 ? 'none' : 'block';
  startBtn.style.display = currentSlide === currentSlides.length - 1 ? 'block' : 'none';
  skipBtn.style.display = (!replayMode && currentSlide === 0) ? 'block' : 'none';

  startBtn.textContent = replayMode ? 'å›åˆ°éŠæˆ²' : 'é–‹å§‹éŠæˆ²';

  /* ===== å³ä¸Šè§’ âœ•ï¼ˆåªåœ¨é‡çœ‹æ¨¡å¼ï¼Œä¸”ä¸æ˜¯æœ€å¾Œä¸€é ï¼‰ ===== */
  let closeBtn = document.getElementById('closeIntroBtn');
  if(!closeBtn){
    closeBtn = document.createElement('button');
    closeBtn.id = 'closeIntroBtn';
    closeBtn.textContent = 'âœ•';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '20px';
    closeBtn.style.right = '20px';
    closeBtn.style.fontSize = '26px';
    closeBtn.style.background = 'transparent';
    closeBtn.style.border = 'none';
    closeBtn.style.color = '#fff';
    closeBtn.style.cursor = 'pointer';

    closeBtn.onclick = function(){
      btnClickSound.currentTime = 0;
      btnClickSound.play();
      document.getElementById('intro').style.display = 'none';
      replayMode = false;
    };

    document.querySelector('.slide').appendChild(closeBtn);
  }

  if(replayMode && currentSlide !== currentSlides.length - 1){
    closeBtn.style.display = 'block';
  }else{
    closeBtn.style.display = 'none';
  }
}


function nextSlide(){if(currentSlide<slides.length-1){currentSlide++;renderSlide();}}
function prevSlide(){if(currentSlide>0){currentSlide--;renderSlide();}}
function startGame(){
  btnClickSound.currentTime=0;
  btnClickSound.play();
  document.getElementById('intro').style.display='none';
  replayMode = false;
}
renderSlide();

// ===== é‡æ–°çœ‹æ“ä½œèªªæ˜ =====
document.getElementById('replayBtn').onclick = function(){
  replayMode = true;
  currentSlide = 0; // replaySlides çš„ç¬¬ä¸€é ï¼ˆåŸæœ¬çš„ slides[1]ï¼‰
  document.getElementById('intro').style.display = 'flex';
  renderSlide();
};

// ===== é‡‘é¡ =====
function updateSum(){document.getElementById('sumText').textContent=showSum?currentSum+'å…ƒ':'ï¼Šï¼Šï¼Šï¼Š';}
document.getElementById('eyeBtn').onclick=function(){showSum=!showSum;updateSum();};
updateSum();

/* ===== å…¶ä»–éŠæˆ²é‚è¼¯ç•¥ï¼ˆæ‹–æ›³ã€åˆ¤å®šã€æ­·å²ï¼‰ ===== */

/* ===== æ‹–æ›³ + é•·æŒ‰å€æ•¸ï¼ˆç©©å®šç‰ˆï¼‰ ===== */

const payZone = document.getElementById('payZone');
const intro = document.getElementById('intro');

let selectedCoin = null;
let selectedOriginCoin = null; // è¨˜ä½æ˜¯å“ªé¡†åŸå§‹éŒ¢å¹£
let offsetX = 0;
let offsetY = 0;
let isHolding = false;
let longPressTimer = null;
let isLongPress = false;


/* ===== æ»‘é¼ ç§»å‹• ===== */
document.addEventListener('mousemove', function(e){
  if(!isHolding || !selectedCoin) return;

selectedCoin.style.left = (e.clientX - offsetX + window.scrollX) + 'px';
selectedCoin.style.top = (e.clientY - offsetY + window.scrollY) + 'px';
});


/* ===== é»æ“Šç•«é¢ â†’ æ”¾ä¸‹ ===== */
document.addEventListener('click', function(e){

  if(!isHolding || !selectedCoin) return;

  const payRect = payZone.getBoundingClientRect();
  const coinRect = selectedCoin.getBoundingClientRect();

  if(
    coinRect.left < payRect.right &&
    coinRect.right > payRect.left &&
    coinRect.top < payRect.bottom &&
    coinRect.bottom > payRect.top
  ){
    // æˆåŠŸæ”¾å…¥ä»˜æ¬¾å€

    selectedCoin.style.position = 'absolute';
    selectedCoin.style.left = (coinRect.left - payRect.left) + 'px';
    selectedCoin.style.top = (coinRect.top - payRect.top) + 'px';

    payZone.appendChild(selectedCoin);

    const val = Number(selectedCoin.dataset.value);
    const multi = Number(selectedCoin.dataset.multiplier || 1);

    currentSum += val * multi;
    updateSum();

    coinPlaceSound.currentTime = 0;
    coinPlaceSound.play();

    selectedCoin.onclick = function(){
      const v = Number(this.dataset.value);
      const m = Number(this.dataset.multiplier || 1);

      currentSum -= v * m;
      updateSum();

      coinRemoveSound.currentTime = 0;
      coinRemoveSound.play();

      this.remove();
    };


  }else{
    selectedCoin.remove();
  }

  // ===== é‡è¨­åŸå§‹éŒ¢å¹£å€ç‡ =====
  if(selectedOriginCoin && payZone.contains(selectedCoin)){
  resetMultiplier(selectedOriginCoin);
}

  selectedCoin = null;
  selectedOriginCoin = null;
  isHolding = false;
});


/* ===== åŸå§‹éŒ¢å¹£äº‹ä»¶ ===== */
document.querySelectorAll('.coin').forEach(coin => {

  /* ===== é•·æŒ‰ ===== */
  coin.addEventListener('mousedown', function(e){

    if(getComputedStyle(intro).display !== 'none') return;

    isLongPress = false;

    longPressTimer = setTimeout(()=>{

  isLongPress = true;

  const rect = coin.getBoundingClientRect();

  const popup = document.createElement('div');
  popup.className = 'multiplierPopup';

  const input = document.createElement('input');
  input.type = 'text';
input.value = coin.dataset.multiplier || 1;
  input.min = 1;
  input.value = coin.dataset.multiplier || 1;

  const confirmBtn = document.createElement('button');
  confirmBtn.className = 'multiplierConfirm';
  confirmBtn.textContent = 'âœ”';

const controls = document.createElement('div');
controls.style.display = 'flex';
controls.style.alignItems = 'center';
controls.style.gap = '10px';

const minus = document.createElement('button');
minus.className = 'multiplierConfirm';
minus.textContent = 'â—€';

const plus = document.createElement('button');
plus.className = 'multiplierConfirm';
plus.textContent = 'â–¶';

minus.onclick = ()=> {
  let v = Number(input.value) || 1;
  if(v > 1) input.value = v - 1;
};

plus.onclick = ()=> {
  let v = Number(input.value) || 1;
  input.value = v + 1;
};

controls.appendChild(minus);
controls.appendChild(input);
controls.appendChild(plus);

popup.appendChild(controls);
popup.appendChild(confirmBtn);

  document.body.appendChild(popup);

  // å›ºå®šåœ¨éŒ¢å¹£æ­£ä¸Šæ–¹æ°´å¹³ç½®ä¸­
popup.style.left = (rect.left + rect.width/2 - popup.offsetWidth/2) + 'px';

// ä¾ç…§éŒ¢å¹£é«˜åº¦å‹•æ…‹æ±ºå®šè·é›¢
const popupHeight = popup.offsetHeight;
const dynamicOffset = rect.height + 10; 

popup.style.left = (rect.left + rect.width/2 - popup.offsetWidth/2 + window.scrollX) + 'px';
popup.style.top = (rect.top - popup.offsetHeight - 10 + window.scrollY) + 'px';

  confirmBtn.onclick = function(){
    const num = Number(input.value);
    if(num > 0){
      coin.dataset.multiplier = num;
      showMultiplierLabel(coin, num);
    }
    popup.remove();
  };

},600);
  });

  coin.addEventListener('mouseup', ()=> clearTimeout(longPressTimer));
  coin.addEventListener('mouseleave', ()=> clearTimeout(longPressTimer));


  /* ===== å–®æ“Šæ‹¿èµ· ===== */
  coin.addEventListener('click', function(e){

    if(getComputedStyle(intro).display !== 'none') return;

    if(isLongPress){
      isLongPress = false;
      return; // é•·æŒ‰å¾Œä¸è¦æ‹¿èµ·
    }

    e.stopPropagation();

    const clone = coin.cloneNode(true);

    clone.dataset.multiplier = coin.dataset.multiplier || 1;

    clone.style.position = 'absolute';
    clone.style.zIndex = 9999;

    document.body.appendChild(clone);

const rect = coin.getBoundingClientRect();

clone.style.left = (e.clientX - rect.width / 2 + window.scrollX) + 'px';
clone.style.top = (e.clientY - rect.height / 2 + window.scrollY) + 'px';

offsetX = rect.width / 2;
offsetY = rect.height / 2;

    selectedCoin = clone;
    selectedOriginCoin = coin;
    isHolding = true;
  });

});


/* ===== é¡¯ç¤ºå€æ•¸æ¨™ç±¤ ===== */
function showMultiplierLabel(coin, num){

  let badge = coin.querySelector('.multiplierBadge');

  if(!badge){
    badge = document.createElement('div');
    badge.className = 'multiplierBadge';
    badge.style.position = 'absolute';
    badge.style.bottom = '-8px';
    badge.style.right = '-8px';
    badge.style.width = '28px';
    badge.style.height = '28px';
    badge.style.borderRadius = '50%';
    badge.style.background = '#0066CC';
    badge.style.color = 'white';
    badge.style.display = 'flex';
    badge.style.alignItems = 'center';
    badge.style.justifyContent = 'center';
    badge.style.fontSize = '14px';
    badge.style.fontWeight = 'bold';
    badge.style.fontFamily = "BpmfZihiKaiStd-Regular";
    coin.appendChild(badge);
  }

  badge.textContent = num;
}


/* ===== é‡è¨­å€ç‡ ===== */
function resetMultiplier(coin){

  coin.dataset.multiplier = 1;

  const badge = coin.querySelector('.multiplierBadge');
  if(badge) badge.remove();
}
/* ===== åˆ¤å®š ===== */
function checkPayment(){

  if(currentSum!==PRICE) return;

  const recordObj={1000:0,100:0,10:0,1:0};

  [...payZone.children].forEach(c=>{
    const value = Number(c.dataset.value);
    const multi = Number(c.dataset.multiplier || 1);
    recordObj[value] += multi;   // â­ é—œéµä¿®æ­£
  });

  const recordKey=JSON.stringify(recordObj);

  const isRepeat = history.includes(recordKey);

  if(isRepeat){

    showMessage(`ä½ å‰›å‰›å·²ç¶“ä½¿ç”¨éé€™ç¨®æ–¹å¼äº†ã€‚<br>æ›ä¸€ç¨®æ”¯ä»˜æ–¹æ³•è©¦è©¦å§ï¼<br>é‚„éœ€è¦å˜—è©¦${REQUIRED_WAYS-history.length}ç¨®ä»˜éŒ¢æ–¹å¼å–”ï¼`,false);
    successRepeatSound.currentTime=0;
    successRepeatSound.play();

    // â­ é‡è¤‡æ‰æ¸…ç©º
    payZone.innerHTML='';
    currentSum=0;
    updateSum();

  }else{

    history.push(recordKey);

    if(history.length<REQUIRED_WAYS){
      showMessage(`ä½ å·²å®Œæˆ${history.length}ç¨®æ”¯ä»˜æ–¹å¼ï¼Œ<br>é‚„è¦å˜—è©¦${REQUIRED_WAYS-history.length}ç¨®æ–¹å¼ä¾†ä»˜éŒ¢ã€‚`,false);
      successNewSound.currentTime=0;
      successNewSound.play();
    }else{
      showMessage(`æ­å–œä½ å·²ç¶“ç”¨äº†3ç¨®ä¸åŒçš„æ–¹å¼ä¾†å®Œæˆæ”¯ä»˜ï¼<br><br>åŒæ¨£çš„é‡‘é¡å¯ä»¥æœ‰å¾ˆå¤šä¸åŒçš„ä»˜æ¬¾æ–¹å¼ã€‚`,true);
      successAllSound.currentTime=0;
      successAllSound.play();
    }

    // â­ ä¸é‡è¤‡æ™‚ä¸è¦æ¸…ç©º
  }
}

/* ===== æç¤ºè¨Šæ¯è¦–çª— ===== */
function showMessage(text, cannotClose){

  const intro = document.getElementById('intro');
  const content = document.getElementById('slideContent');
  const btn = document.getElementById('startBtn');

  // éš±è—é ç¢¼èˆ‡ç•¥é
  document.getElementById('slideNumber').style.display = 'none';
  document.getElementById('skipBtn').style.display = 'none';
  document.getElementById('prevBtn').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'none';

  intro.style.display = 'flex';
  intro.style.zIndex = 50000;

  // ===== å¦‚æœå·²å®Œæˆå…¨éƒ¨ä¸‰ç¨® =====
  if(cannotClose){

    btn.style.display = 'none';

content.innerHTML = `
<div style="
  display:flex;
  flex-direction:column;
  min-height:90vh;        /* â­ ç”¨æœ€å°é«˜åº¦æ’é–‹ï¼Œè€Œä¸æ˜¯ä¾è³´çˆ¶å±¤ */
  font-size:22px;
  line-height:1.8;
  text-align:left;
  padding:40px;
  box-sizing:border-box;
">

  <div style="
    flex-grow:1;           /* â­ åƒæ‰ä¸­é–“ç©ºé–“ï¼ŒæŠŠæŒ‰éˆ•å¾€ä¸‹æ¨ */
    margin-bottom:40px;    /* â­ æ–‡å­—èˆ‡æŒ‰éˆ•ä¿æŒè·é›¢ */
  ">
    ${text}
  </div>

  <div style="
    display:flex;
    justify-content:center;
    gap:20px;
    margin-top:auto;       /* â­ ç›¸å°å®šä½æ¨åˆ°åº•ï¼ˆé absoluteï¼‰ */
    padding-top:20px;
  ">
    <button id="restartBtn"
      style="font-size:22px;padding:12px 30px;border-radius:14px;border:none;background:#0066CC;color:white;font-family:BpmfZihiKaiStd-Regular;cursor:pointer;">
      å†ç©ä¸€æ¬¡
    </button>

    <button id="closeGameBtn"
      style="font-size:22px;padding:12px 30px;border-radius:14px;border:none;background:#444;color:white;font-family:BpmfZihiKaiStd-Regular;cursor:pointer;">
      é—œé–‰éŠæˆ²
    </button>
  </div>

</div>`;

    document.getElementById('restartBtn').onclick = function(){
      location.reload();
    };

    document.getElementById('closeGameBtn').onclick = function(){
      window.close();
    };

  }else{

    // ===== åªæ˜¯å®Œæˆå…¶ä¸­ä¸€ç¨® =====
    btn.style.display = 'block';
    btn.textContent = 'ç¹¼çºŒ';

content.innerHTML = `
<div style="
  display:flex;
  height:100%;
  font-size:22px;
  line-height:1.8;
  text-align:left;
  align-items:center;      /* å‚ç›´ç½®ä¸­ */
  justify-content:flex-start; /* æ°´å¹³é å·¦ */
  padding:40px;
  box-sizing:border-box;
">
  <div>
    ${text}
  </div>
</div>`;

    btn.onclick = function(){
      btnClickSound.currentTime = 0;
      btnClickSound.play();
      intro.style.display = 'none';
    };
  }
}

/* ===== æ­·å² ===== */
document.getElementById('historyBtn').onclick=function(){
  const modal=document.getElementById('modal');
  const content=document.getElementById('modalContent');
  content.innerHTML=`<h2>${PRICE}å…ƒ</h2>`;
  if(history.length===0){content.innerHTML+='<p>ç›®å‰é‚„æ²’æœ‰å®Œæˆéæ”¯ä»˜</p>';}
  else history.forEach((r,i)=>{
    const obj=JSON.parse(r);
    content.innerHTML+=`<div class="historyBlock">
      <div class="historyTitle">ç¬¬${i+1}ç¨®æ–¹å¼</div>
      <div class="historyCoins">${renderHistoryCoins(obj)}</div>
    </div>`;
  });
  modal.style.display='flex';
  modal.style.zIndex=100;
};
document.getElementById('modal').onclick=function(e){if(e.target.id==='modal')this.style.display='none';};

function renderHistoryCoins(obj){
  const order=[1000,100,10,1];
  let html='';

  order.forEach(v=>{
    if(obj[v]>0){

      // åˆ¤æ–·é‡è©
      const unit = (v === 1000 || v === 100) ? 'å¼µ' : 'å€‹';

      html+=`<div class="coinWrapper">
        <div class="coin" data-value="${v}" style="cursor:default;">${v}</div>
        <div class="times">x${obj[v]}${unit}</div>
      </div>`;
    }
  });

  return html;
}


/* ===== å®Œæˆä»˜æ¬¾ ===== */
document.getElementById('finishBtn').onclick = function(){
  if(currentSum === 0){
    // å°šæœªæ”¾éŒ¢å¹£ â†’ è·Ÿé‡‘é¡æœªé”æ™‚ä¸€æ¨£æ¨£å¼
    showGameModal('ä½ é‚„æ²’æœ‰æ”¾å…¥ä»»ä½•éŒ¢å¹£å–”ï¼');
    return;
  }

  if(currentSum !== PRICE){
    // é‡‘é¡ä¸å°
    showGameModal('ç¾åœ¨ä»˜çš„é‡‘é¡ä¸æ˜¯å•†å“çš„åƒ¹éŒ¢å–”ï¼');
  } else {
    checkPayment();
  }
};

function showGameModal(text){
  const modal = document.getElementById('gameModal');
  const textBox = document.getElementById('gameModalText');
  const btn = document.getElementById('gameModalBtn');

  // æ”¾æ–‡å­—
  textBox.innerHTML = `<div style="font-size:22px;line-height:1.8;">${text}</div>`;

  // é¡¯ç¤ºå½ˆçª— & åŠé€æ˜èƒŒæ™¯
  modal.style.display = 'flex';
  modal.style.background = 'rgba(0,0,0,0.55)'; // é»‘ç°åŠé€æ˜ï¼Œåƒ intro

  btn.onclick = function(){
    btnClickSound.currentTime = 0;
    btnClickSound.play();
    modal.style.display = 'none';
  };
}

</script>
</body>
</html>
